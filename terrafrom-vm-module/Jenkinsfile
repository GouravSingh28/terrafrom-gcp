pipeline {
    agent any
    parameters {
        string(name: 'PROJECT_ID', defaultValue: 'terraform-learning-442205', description: 'GCP Project ID')
        string(name: 'REGION', defaultValue: 'us-central1', description: 'GCP Region')
        //string(name: 'ZONE', defaultValue: 'us-central1-a', description: 'GCP Zone')
        string(name: 'VM_NAME', defaultValue: 'test-vm-1', description: 'Name of the VM')
        string(name: 'MACHINE_TYPE', defaultValue: 'e2-micro', description: 'Machine type (e.g., e2-medium)')
        string(name: 'DISK_IMAGE', defaultValue: 'debian-cloud/debian-11', description: 'Source image for the boot disk')
        string(name: 'NETWORK', defaultValue: 'default', description: 'VPC network name')
        string(name: 'SERVICE_ACCOUNT_EMAIL', defaultValue: 'gouravsingh335@gmail.com', description: 'Service account email')
    }
    environment {
        GOOGLE_CREDENTIALS = credentials('gcp-json') // Add this in Jenkins credentials
        PROJECT_ID = 'terraform-learning-442205'
        TERRAFORM_VERSION = '1.9.8' // Replace with the version you need
    }

    stages {
           
		 stage('GIT CHECKOUT')
        {		  
		   steps{
		   script {
		   git credentialsId: 'terrafor-gcp-token', branch: 'main', url: "https://github.com/GouravSingh28/terrafrom-gcp.git" 
		   }
		   
		   }
		}


       stage('Debug Workspace') {
            steps {
                withCredentials([file(credentialsId: 'gcp-json', variable: 'GOOGLE_APPLICATION_CREDENTIALS_FILE')]) {
                    dir('terrafrom-vm-module') { sh '''
                        # Export credentials for Terraform
                        export GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS_FILE
                        
                        # Run Terraform commands
                        terraform init
                        terraform plan -out=tfplan \
                            -var="project_id=${PROJECT_ID}" \
                            -var="region=${REGION}" \
                            -var="vm_name=${VM_NAME}" \
                            -var="machine_type=${MACHINE_TYPE}" \
                            -var="disk_image=${DISK_IMAGE}" \
                            -var="network=${NETWORK}" \
                            -var="service_account_email=${SERVICE_ACCOUNT_EMAIL}"
                    '''
                }
            }
        }
    }
        stage('Apply') {
            steps {
            withCredentials([file(credentialsId: 'gcp-json', variable: 'GOOGLE_APPLICATION_CREDENTIALS_FILE')]) {    
            dir('terrafrom-vm-module') {    
                sh '''
                    export GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS_FILE
                    echo "Checking credentials..."
                    ls -l $GOOGLE_APPLICATION_CREDENTIALS
                    cat $GOOGLE_APPLICATION_CREDENTIALS
                    terraform apply tfplan
                '''
            }
        } 
    }
}
}
}
