pipeline {
    agent any
    parameters {
        string(name: 'SERVER_IP', defaultValue: '', description: 'Enter the IP address of the target server')
        string(name: 'Username', defaultValue: 'gouravsingh335', description: 'Enter the username for login')
    }
    environment {
        SSH_CREDENTIALS_ID = 'ssh-user-key'  // Replace with your Jenkins SSH credentials ID
        INSTALL_SCRIPT = './install-script.sh'  // Update with the path to your installation script
    }
    stages {
        stage('Validate Input') {
            steps {
                script {
                    if (params.SERVER_IP == '') {
                        error("SERVER_IP parameter is required.")
                    }
                }
            }
        }
        stage('Run Installation Script') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: env.SSH_CREDENTIALS_ID, keyFileVariable: 'SSH_KEY_FILE', usernameVariable: 'SSH_USER')]) {
                    script {
                        // Start ssh-agent and add the key
                        sh """
                        eval \$(ssh-agent -s)
                        ssh-add ${SSH_KEY_FILE}
                        """

                        // Transfer the script to the target server
                        sh """
                        scp -o StrictHostKeyChecking=no ${env.INSTALL_SCRIPT} ${SSH_USER}@${params.SERVER_IP}:/tmp/install-script.sh
                        """

                        // Run the script on the target server
                        sh """
                        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${params.SERVER_IP} "bash /tmp/install-script.sh"
                        """
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Installation script executed successfully on ${params.SERVER_IP}."
        }
        failure {
            echo "Failed to run the installation script on ${params.SERVER_IP}."
        }
    }
}
